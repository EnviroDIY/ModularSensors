# The SAMD clock system<!-- {#page_samd_clocks} -->

[//]: # ( @tableofcontents )

[//]: # ( @m_footernavigation )

[//]: # ( Start GitHub Only )

- [The SAMD clock system](#the-samd-clock-system)
  - [SAMD21](#samd21)
    - [The SAMD21 clock system](#the-samd21-clock-system)
    - [SAMD21 Settings at Power On](#samd21-settings-at-power-on)
    - [SAMD21 Arduino Core Clock Generator Configuration](#samd21-arduino-core-clock-generator-configuration)
    - [SAMD21 Arduino Core Watch Dog and External Interrupt Clock Configuration](#samd21-arduino-core-watch-dog-and-external-interrupt-clock-configuration)
    - [Clocks used by other libraries for the SAMD21](#clocks-used-by-other-libraries-for-the-samd21)
  - [SAMD51 and SAME51](#samd51-and-same51)
    - [The SAMD51 clock system](#the-samd51-clock-system)
    - [SAMD51 Settings at Power On](#samd51-settings-at-power-on)
  - [SAMD51 Arduino Core Clock Generator Configuration](#samd51-arduino-core-clock-generator-configuration)
    - [SAMD51 Arduino Core Watch Dog and External Interrupt Clock Configuration](#samd51-arduino-core-watch-dog-and-external-interrupt-clock-configuration)
    - [Clocks used by other libraries for the SAMD51](#clocks-used-by-other-libraries-for-the-samd51)

[//]: # ( End GitHub Only )


## SAMD21<!-- {#samd21_clocks} -->

### The SAMD21 clock system<!-- {#samd21_clock_system} -->

From the SAMD21 Datasheet 14.1:

> The clock system on the SAM D21 consists of :
>
> - *Clock sources*, controlled by SYSCTRL
>   – A clock source provides a time base that is used by other components, such as Generic Clock Generators.
> Example clock sources are the internal 8MHz oscillator(OSC8M), External crystal oscillator(XOSC) and the Digital frequency locked loop (DFLL48M).
> - *Generic Clock Controller(GCLK)* which controls the clock distribution system, made up of:
>   - *Generic Clock Generators*: These are programmable prescalers that can use any of the system clock sources as a time base.  The Generic Clock Generator 0 generates the clock signal GCLK_MAIN, which is used by the Power Manager, which in turn generates synchronous clocks.
>     - Generic clock generators are configured with `GCLK->GENCTRL`
>   - *Generic Clocks*: These are clock signals generated by Generic Clock Generators and output by the Generic Clock Multiplexer, and serve as clocks for the peripherals of the system.  Multiple instances of a peripheral will typically have a separate Generic Clock for each instance. Generic Clock 0 serves as the clock source for the DFLL48M clock input (when multiplying another clock source).
>     - Generic clocks are configured with `GCLK->CLKCTRL`
> - Power Manager (PM)
>   - The PM generates and controls the synchronous clocks on the system.
> This includes the CPU, bus clocks (APB, AHB) as well as the synchronous (to the CPU) user interfaces of the peripherals.  It contains clock masks that can turn on/off the user interface of a peripheral as well as prescalers for the CPU and bus clocks

### SAMD21 Settings at Power On<!-- {#samd21_clock_power_on} -->

After a power-on reset, the clock generators for peripherals default to:

- RTC: GCLK0
- WDT: GCLK2
- Anything else: GCLK0
- See 14.8 in the SAMD21 Datasheet
-

See [section 13.7 of the datasheet](https://onlinedocs.microchip.com/oxy/GUID-F5813793-E016-46F5-A9E2-718D8BCED496-en-US-13/GUID-4F945BA9-D138-4F79-AA1A-5CFF0E67A977.html)

### SAMD21 Arduino Core Clock Generator Configuration<!-- {#samd21_clock_arduino_core} -->

[Within the SAMD core for the SAMD21](https://github.com/adafruit/ArduinoCore-samd/blob/ce20340620bfd9c545649ee5c4873888ee0475d0/cores/arduino/startup.c#L311) SystemInit() in startup.c configures clocks with these steps:

- Enable XOSC32K clock (external on-board 32.768Hz oscillator) or OSC32K (if crystalless).
  - This will be used as DFLL48M reference.
  - SystemInit() uses a default start-up configuration of 0x6 for the (X)OSC (65536 OSCULP32K clock cycles + 3 (X)OSC32K clock cycles = 2000092μs ~= 2s before PCLKSR.XOSC32KRDY is set.)

> [!NOTE]
> The SystemInit() function **blocks** while waiting for oscillator stabilization.

- Put XOSC32K or OSC32K as source of Generic Clock Generator 1
- Put Generic Clock Generator 1 as source for Generic Clock Multiplexer 0 (DFLL48M reference)
- Enable DFLL48M clock
- Switch Generic Clock Generator 0 to DFLL48M. CPU will run at 48MHz.
- Modify prescaler value of OSCM to have 8MHz
- Put OSC8M as source for Generic Clock Generator 3

### SAMD21 Arduino Core Watch Dog and External Interrupt Clock Configuration<!-- {#samd21_clock_wdt_eic} -->

The watchdog must be attached to a clock source so it can tell how much time has passed and whether it needs to bite.
The watchdog peripheral clock is not configured by the core.

The external interrupt controller must be attached to a currently-on clock to tell the difference between rising and HIGH or falling and LOW interrupts.
If the external interupt controller is not attached to a running clock, then interrupts will not work!
Thus, if the clock source for interrupts is not running in standby, the interrupts will not be able to wake the device.
In [WInterrupts.c](https://github.com/adafruit/ArduinoCore-samd/blob/ce20340620bfd9c545649ee5c4873888ee0475d0/cores/arduino/WInterrupts.c#L56) in the Adafruit SAMD core, generic clock generator 0 (ie GCLK_MAIN) is used for the EIC peripheral.
The Arduino core does *NOT* configure the generic clock generator 0 (ie GCLK_MAIN = DFLL48M) to stay awake in standby!

### Clocks used by other libraries for the SAMD21<!-- {#samd21_clock_other_libraries} -->

- [RTCZero](https://github.com/arduino-libraries/RTCZero/)
  - Configures the RTC's generic clock (GCM_RTC) to use generic clock generator 2
  - Sets the source for GCKL2 as a 32k oscillator
    - external preferred, internal ultra-low power if cyrstalless
  - Uses a 32x divisor to get 1024Hz(ish) clock for time keeping.
- [Adafruit SleepDog](https://github.com/adafruit/Adafruit_SleepyDog)
  - Configures the WDT's generic clock (GCM_WDT) to use generic clock generator 2.
  - Sets the source for GCKL2 as the internal ultra-low power 32k oscillator
  - Uses a 32x divisor to get a 1024Hz(ish) clock to manage the watchdog.

> [!NOTE]
> RTCZero and Adafruit's sleepy dog choose different sources for GCKL2!

- [Arduino Low Power](https://github.com/arduino-libraries/ArduinoLowPower)
  - Configures the EIC and ADC's generic clocks (GCM_EIC and GCM_ADC) to use generic clock generator 6
  - Sets the source for GCKL6 as athe internal ultra-low power 32k oscillator
  - Does *NOT* use any clock divisor

> [!NOTE]
> The ZeroPowerManager library changes other clocks (including the main clock source, GCLK_MAIN, which is always sourced from GCLKGEN[0]) to reduce power draw.
> Changing the GCLK_MAIN configuration will cause some functions like delay() to operate incorrectly.
> To avoid any confusing with delay(), we're not going to change anything with GCLK0.
> This means we won't be in the lowest power state like that offered by ZeroPowerManager
> @TODO: Revisit this decision

- [EnviroDIY SDI-12](https://github.com/EnviroDIY/Arduino-SDI-12)
  - Configures the TCC2/TC3 clock (GCM_TCC2_TC3) to use generic clock generator 4 (`GENERIC_CLOCK_GENERATOR_SDI12` = 4)
  - Sets the source for GCKL4 as the DFLL48M - which is in-turn coming from "main" clock set up in SystemInit() in startup.c.
  - Uses a 6x divisor.
- [Modular Sensors (this library)](https://github.com/EnviroDIY/ModularSensors)
  - Configures the EIC and WDT's generic clocks (GCM_EIC and GCM_WDT) to use generic clock generator 5 (`GENERIC_CLOCK_GENERATOR_MS` = 5)
  - Sets the source for GCKL5 as the internal ultra-low power 32k oscillator.
  - Uses a 32x divisor to get a 1024Hz(ish) clock to manage the watchdog and EIC.

## SAMD51 and SAME51<!-- {#samd51_clocks} -->

### The SAMD51 clock system<!-- {#samd51_clock_system} -->

[From 13.1 of the SAMD51 Datasheet](https://onlinedocs.microchip.com/oxy/GUID-F5813793-E016-46F5-A9E2-718D8BCED496-en-US-13/GUID-FC6F58EC-FCDA-4478-AE60-45F2E160FF94.html))

> The SAM D5x/E5x clock system consists of:
>
> - *Clock sources*, i.e. oscillators controlled by OSCCTRL and OSC32KCTRL
>   - A clock source provides a time base that is used by other components, such as Generic Clock Generators.  Example clock sources include the external crystal oscillators (XOSC0 and XOSC1) and the Digital Frequency Locked Loop (DFLL48M).
> - *Generic Clock Controller (GCLK)*, which generates, controls and distributes asynchronous clocks consisting of:
>   - *Generic Clock Generators:* These are programmable prescalers that can use any of the system clock sources as a time base. The Generic Clock Generator 0 generates the clock signal GCLK_MAIN, which is used by the Power Manager and the Main Clock (MCLK) module, which in turn generates synchronous clocks.
> - *Generic Clocks:* These are clock signals generated by Generic Clock Generators and output by the Peripheral Channels, and serve as clocks for the peripherals of the system. Multiple instances of a peripheral will typically have a separate Generic Clock for each instance. Generic Clock 0 serves as the clock source for the DFLL48M clock input (when multiplying another clock source).
> - *Main Clock Controller (MCLK)*
>   - The MCLK generates and controls the synchronous clocks on the system. This includes the CPU, bus clocks (APB, AHB) as well as the synchronous (to the CPU) user interfaces of the peripherals. It contains clock masks that can turn on/off the user interface of a peripheral as well as prescalers for the CPU and bus clocks.

### SAMD51 Settings at Power On<!-- {#samd51_clock_power_on} -->

[See section 13.7 of the datasheet.](https://onlinedocs.microchip.com/oxy/GUID-F5813793-E016-46F5-A9E2-718D8BCED496-en-US-13/GUID-4F945BA9-D138-4F79-AA1A-5CFF0E67A977.html)

## SAMD51 Arduino Core Clock Generator Configuration<!-- {#samd51_clock_arduino_core} -->

[Within the SAMD core for the SAMD21](https://github.com/adafruit/ArduinoCore-samd/blob/ce20340620bfd9c545649ee5c4873888ee0475d0/cores/arduino/startup.c#L57) SystemInit() in startup.c configures clocks with these steps:

- Enable XOSC32K clock (external on-board 32.768Hz oscillator) if available
- Set XOSC32K or OSC32K as source of Generic Clock Generator 3
- Set OSCULP32K (internal ultra-low power 32.768Hz oscillator) as the source for Generic Clock Generator 0
  - NOTE: The default power-on source of generic clock generator 0 is the DFLL48.
  - NOTE: Farther down, generic clock generator 0 is resourced from DPLL0 (at 120MHz)
- Configure the DFLL48M clock in open loop mode
  - Source generic clock generator 5 from the DFLL with a divisor of 48
- Configure DPLL peripheral clocks
  - Configure PLL0 at 120MHz, using generic clock generator 5 (from the DFLL48M) as the reference clock
  - Configure PLL1 at 100MHz, using generic clock generator 5 (from the DFLL48M) as the reference clock
- Configure other genericl clock generators to use for peripheral clocks
  - Source generic clock generator 1 from the DFLL48M with no divisor
    - 48MHz clock generator; used for the USB and "stuff"
  - Source generic clock generator 2 from the PLL1 at 100MHz with no divisor
    - 100MHz clock generator; used for "other peripherals"
  - Source generic clock generator 4 from the DFLL48M at 48MHz with 4x divisor
    - 12MHz clock generator; used for the DAC
- Set the main clock source as the source for the main generic clock generator
  - `MAIN_CLOCK_SOURCE` = `GCLK_GENCTRL_SRC_DPLL0`
  - `GENERIC_CLOCK_GENERATOR_MAIN` = 0
  - This is resetting the source of generic clock generator 0 to be the DPLL0 at 120MHz, it previously had been set to the OSCULP32K.

### SAMD51 Arduino Core Watch Dog and External Interrupt Clock Configuration<!-- {#samd51_clock_wdt_eic} -->

The SAMD51 WDT uses OSCULP32k directly; no separate clock generator or peripheral clock configuration is needed.

The external interrupt controller must be attached to a currently-on clock to tell the difference between rising and HIGH or falling and LOW interrupts.
If the external interupt controller is not attached to a running clock, then interrupts will not work!
Thus, if the clock source for interrupts is not running in standby, the interrupts will not be able to wake the device.
In [WInterrupts.c](https://github.com/adafruit/ArduinoCore-samd/blob/ce20340620bfd9c545649ee5c4873888ee0475d0/cores/arduino/WInterrupts.c#L48) in the Adafruit SAMD core, generic clock generator 2 (from the PLL1 at 100MHz with no divisor) is used for the EIC peripheral.
The Arduino core does *NOT* configure the generic clock generator 0 (ie GCLK_MAIN = DFLL48M) to stay awake in standby!

### Clocks used by other libraries for the SAMD51<!-- {#samd51_clock_other_libraries} -->

- [RTCZero](https://github.com/arduino-libraries/RTCZero/)
  - The RTC of the SAMD51 is sourced directly from an oscillator, not via the generic clock generator system. This library only configures the RTC oscillator on the SAMD51.
- [Adafruit SleepDog](https://github.com/adafruit/Adafruit_SleepyDog)
  - The WDT on the SAMD51 is directly attached to OSCULP32K. This library doesn't make any clock changes for the SAMD51.
- [Arduino Low Power](https://github.com/arduino-libraries/ArduinoLowPower)
  - This library doesn't support the SAMD51
- [EnviroDIY SDI-12](https://github.com/EnviroDIY/Arduino-SDI-12)
  - Configures the TC2 clock (TC2_GCLK_ID) to use generic clock generator 6 (`GENERIC_CLOCK_GENERATOR_SDI12` = 6)
  - Sets the source for GCKL6 as the DPLL0 at 120MHz
  - Uses a 15x divisor between the DPLL0 and GCKL6.
- [Modular Sensors (this library)](https://github.com/EnviroDIY/ModularSensors)
  - This library only ensures that the OSCULP32K is used to source the EIC, it does not change any clocks.
